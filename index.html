<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>The Universal Office</title>
 <link rel="preconnect" href="https://fonts.googleapis.com">
 <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
 <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=IM+Fell+English:ital@0;1&family=Cinzel+Decorative:wght@400;700&display=swap" rel="stylesheet">
 <style>
    #ecumenical-devotions-section,
    #during-office-section,
    #closing-devotions-section {
        transition: opacity 0.3s, max-height 0.3s;
        overflow: hidden;
        max-height: 600px;
        opacity: 1;
    }
    #ecumenical-devotions-section.bcp-only-hidden,
    #during-office-section.bcp-only-hidden,
    #closing-devotions-section.bcp-only-hidden {
        max-height: 0;
        opacity: 0;
        margin: 0;
        padding: 0;
        pointer-events: none;
    }
    :root {
        --bg-color: #f0ebe0;
        --text-color: #2a1f14;
        --container-bg: #faf6ee;
        --accent: #8e44ad;
        --gold: #c9a84c;
        --sidebar-bg: #1a1410;
    }
    body.dark-mode {
        --bg-color: #1a1008;
        --text-color: #f0e6cc;
        --container-bg: #221508;
        --accent: #e8472a;
        --sidebar-bg: #0e0a05;
    }
    body {
        font-family: 'IM Fell English', Georgia, serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        overflow-y: hidden;
        transition: all 0.3s;
    }
    #mode-selection {
        text-align: center;
        max-width: 600px;
        padding: 50px 40px;
        background: rgba(0, 0, 0, 0.72);
        border-radius: 4px;
        box-shadow: 0 8px 40px rgba(0,0,0,0.7);
        border: 1px solid rgba(201, 168, 76, 0.3);
        position: relative;
        z-index: 2;
    }
    #mode-selection h1 {
        font-family: 'Cinzel Decorative', 'Cinzel', serif;
        font-size: 2.2em;
        margin-bottom: 12px;
        color: var(--gold);
        letter-spacing: 0.06em;
        text-shadow: 0 2px 12px rgba(0,0,0,0.8);
    }
    #mode-selection p {
        font-family: 'Cinzel', serif;
        font-size: 0.85em;
        letter-spacing: 0.15em;
        text-transform: uppercase;
        color: #a89878;
        margin-bottom: 28px;
    }
    #splash-bg {
    position: fixed;
    inset: 0;
    /* Use a solid color or a standard URL to prevent context window bloat */
    background-color: var(--sidebar-bg);
    background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('/images/canterbury.png');
    background-size: 90%; 
    background-position: center 5%;
    background-repeat: no-repeat;
    filter: blur(8px);
    z-index: 1;
}
    body:not(.office-active) {
        background-color: #000 !important;
    }
    .mode-btn {
        background: transparent;
        color: var(--gold);
        border: 1px solid var(--gold);
        padding: 12px 30px;
        margin: 8px;
        cursor: pointer;
        font-family: 'Cinzel', serif;
        font-size: 0.95em;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        border-radius: 2px;
        transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    }
    .mode-btn:hover {
        background: rgba(201, 168, 76, 0.15);
        box-shadow: 0 0 12px rgba(201, 168, 76, 0.2);
        color: #e8d090;
    }
    #daily-office-section { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100vh; flex-direction: row; }
    #individual-prayers-section {
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
   background-image: linear-gradient(rgba(0,0,0,0.65), rgba(0,0,0,0.65)), url('/images/york-lancets.png');
    background-size: cover;
    background-position: center center;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 200;
}
    #settings-panel.sidebar-hidden {
        transform: translateX(-300px);
        pointer-events: none;
    }
    #sidebar-toggle {
        position: fixed;
        left: 300px;
        top: 0;
        width: 24px;
        height: 100vh;
        background: #0d0801;
        border-right: 1px solid rgba(201,168,76,0.3);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 101;
        transition: left 0.3s ease;
        writing-mode: vertical-rl;
        text-orientation: mixed;
        color: var(--gold);
        font-family: 'Cinzel', serif;
        font-size: 0.55em;
        letter-spacing: 3px;
        text-transform: uppercase;
        user-select: none;
        opacity: 0.45;
    }
    #sidebar-toggle:hover {
        opacity: 1;
        background: #180f04;
    }
    #sidebar-toggle.sidebar-hidden {
        left: 0;
        opacity: 0.6;
    }
    #main-content.sidebar-hidden {
        margin-left: 24px;
    }
    #settings-panel {
        width: 300px;
        background: linear-gradient(180deg, #110a02 0%, #0d0801 100%);
        color: #c8bfa8;
        padding: 28px 25px;
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        overflow-y: auto;
        border-right: 1px solid rgba(201, 168, 76, 0.35);
        box-shadow: inset -4px 0 18px rgba(150,80,0,0.08), 4px 0 20px rgba(0,0,0,0.5);
        transition: transform 0.3s ease;
        z-index: 100;
    }
    .setting-group {
        margin-bottom: 25px;
        text-align: left;
    }
    .setting-group strong {
        display: block;
        margin-bottom: 10px;
        color: var(--gold);
        text-transform: uppercase;
        letter-spacing: 2px;
        font-family: 'Cinzel', serif;
        font-size: 0.7em;
    }
    .setting-group label {
        display: block;
        margin-bottom: 10px;
        cursor: pointer;
        font-size: 0.9em;
        font-family: 'IM Fell English', serif;
        color: #b8af98;
    }
    .nested-group {
        margin-left: 15px;
        margin-top: 10px;
    }
    #main-content {
        margin-left: 300px;
        transition: margin-left 0.3s ease;
        padding: 40px;
        height: 100vh;
        overflow-y: auto;
        text-align: center;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        width: calc(100% - 300px);
        background: radial-gradient(ellipse at center, #2a1a0a 0%, #130c04 100%);
    }
    #main-content::-webkit-scrollbar {
        width: 5px;
    }
    #main-content::-webkit-scrollbar-thumb {
        background: rgba(201, 168, 76, 0.4);
        border-radius: 2px;
    }
    #main-content::-webkit-scrollbar-track {
        background: #0e0a05;
    }
    .ornamental-divider {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 40px 0;
        width: 100%;
    }
    .ornamental-divider .div-line-left {
        flex: 1;
        height: 1px;
        background: linear-gradient(to right, transparent, rgba(201,168,76,0.55));
    }
    .ornamental-divider .div-line-right {
        flex: 1;
        height: 1px;
        background: linear-gradient(to left, transparent, rgba(201,168,76,0.55));
    }
    .ornamental-divider-glyph {
        color: rgba(201,168,76,0.8);
        font-size: 1em;
        padding: 0 16px;
        line-height: 1;
        font-family: Georgia, serif;
        letter-spacing: 8px;
    }
    .office-container {
        background: linear-gradient(160deg, rgba(45,28,10,0.45) 0%, rgba(30,18,5,0.45) 60%, rgba(42,24,8,0.45) 100%);
        max-width: 800px;
        margin: 0 auto;
        padding: 70px 80px;
        border-radius: 1px;
        box-shadow: 0 0 0 1px rgba(201,168,76,0.5),
                    0 0 0 4px rgba(139,90,30,0.25),
                    0 0 0 5px rgba(201,168,76,0.2),
                    0 12px 50px rgba(0,0,0,0.7),
                    inset 0 0 80px rgba(180,100,20,0.09),
                    inset 0 0 200px rgba(0,0,0,0.15);
        text-align: left;
        border-left: none;
        position: relative;
    }
    .office-container::before {
        content: '';
        position: absolute;
        inset: 8px;
        border: 1px solid rgba(201,168,76,0.15);
        pointer-events: none;
        z-index: 2;
    }
    .office-container::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 1px;
        background-image: url("data:image/png;base64,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");
        background-repeat: repeat;
        background-size: 64px 64px;
        opacity: 0.045;
        mix-blend-mode: overlay;
        pointer-events: none;
        z-index: 1;
    }
    h1 { font-family: 'Cinzel', serif; font-size: 2.4em; letter-spacing: 0.06em; margin-bottom: 0.5em; color: var(--gold); }
    h2 { font-family: 'Cinzel', serif; font-size: 1.9em; color: #ecc85a; border-bottom: 1px solid rgba(201,168,76,0.4); padding-bottom: 12px; margin-top: 0; letter-spacing: 0.04em; text-shadow: 0 1px 10px rgba(200,130,0,0.4); }
    .liturgical-title {
        color: var(--gold);
        font-family: 'Cinzel', serif;
        font-variant: small-caps;
        font-weight: 600;
        font-size: 1.3em;
        letter-spacing: 0.05em;
        margin: 0 0 30px 0;
        opacity: 0.9;
    }
    .rubric-text {
        color: #e8472a;
        text-shadow: 0 0 12px rgba(220, 80, 40, 0.45);
        font-family: 'Cinzel', serif;
        font-variant: small-caps;
        font-weight: 600;
        font-size: 1.35em;
        letter-spacing: 0.06em;
        display: block;
        margin-top: 40px;
        margin-bottom: 12px;
        border-bottom: 0.5px dotted rgba(201,168,76,0.35);
        padding-bottom: 6px;
        width: 100%;
    }
    .passage-reference {
        font-size: 1.25em;
        font-style: italic;
        color: var(--gold);
        margin: 8px 0 16px 0;
        font-weight: normal;
        opacity: 0.9;
        font-family: 'IM Fell English', serif;
    }
    .component-text {
        font-family: 'IM Fell English', Georgia, serif;
        font-size: 1.35em;
        line-height: 1.9;
        margin-bottom: 30px;
        display: block;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow: visible;
    }
    .reading-text {
        font-family: 'IM Fell English', Georgia, serif;
        font-size: 1.35em;
        line-height: 1.95;
        margin-bottom: 30px;
        display: block;
        word-wrap: break-word;
        text-align: justify;
        hyphens: auto;
    }
    .reading-text p {
        margin: 0 0 1.1em 0;
        text-indent: 1.8em;
    }
    .reading-text p:first-child {
        text-indent: 0;
    }
    .psalm-stanza {
        font-family: 'IM Fell English', Georgia, serif;
        font-size: 1.35em;
        line-height: 1.95;
        margin-bottom: 0.5em;
        display: block;
    }
    .psalm-stanza .psalm-half-verse {
        display: block;
        padding-left: 2em;
        color: var(--text-color);
    }
    .psalm-stanza .psalm-half-verse:first-child {
        padding-left: 0;
    }
    .psalm-block {
        margin-bottom: 30px;
        display: block;
    }
    .psalm-verse { display: block; margin-bottom: 10px; font-size: 1.35em; line-height: 1.9; }
    .verse-num { font-size: 0.65em; color: var(--gold); vertical-align: super; margin-right: 8px; opacity: 0.8; }
    .saint-section { margin-top: 60px; border-top: none; padding-top: 0; }
    .saint-section-divider {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 0 40px 0;
        width: 100%;
    }
    .saint-section-divider .sdiv-left {
        flex: 1;
        height: 1px;
        background: linear-gradient(to right, transparent, rgba(201,168,76,0.45));
    }
    .saint-section-divider .sdiv-right {
        flex: 1;
        height: 1px;
        background: linear-gradient(to left, transparent, rgba(201,168,76,0.45));
    }
    .saint-section-divider span {
        color: var(--gold);
        font-family: 'Cinzel', serif;
        font-size: 0.75em;
        letter-spacing: 0.3em;
        text-transform: uppercase;
        padding: 0 20px;
        opacity: 0.7;
    }
    .saint-grid { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
    .saint-box { background: var(--container-bg); border-top: 5px solid var(--gold); padding: 20px; width: 240px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); text-align: left; border-radius: 0 0 6px 6px; }
    .ordo-control { background: rgba(201, 168, 76, 0.05); border: 1px solid rgba(201, 168, 76, 0.3); padding: 15px; border-radius: 2px; margin-bottom: 20px; text-align: center; width: 250px; box-sizing: border-box; }
    .ordo-date { display: block; color: var(--gold); font-weight: bold; margin: 10px 0; font-size: 1em; white-space: normal; word-break: break-word; font-family: 'Cinzel', serif; }
    .ordo-buttons { display: flex; justify-content: center; gap: 5px; }
    .ordo-btn { background: none; border: 1px solid rgba(201, 168, 76, 0.4); color: var(--gold); padding: 5px 15px; cursor: pointer; transition: background 0.2s; font-family: 'Cinzel', serif; font-size: 0.8em; letter-spacing: 0.08em; border-radius: 1px; }
    .ordo-btn:hover { background: rgba(201, 168, 76, 0.15); }
    #main-content h1 {
        font-family: 'Cinzel', serif;
        font-size: 1.8em;
        color: var(--gold);
        letter-spacing: 0.08em;
        margin-bottom: 0.4em;
        text-align: center;
    }
    select { width: 100%; padding: 10px; background: #1e1a14; color: #c8bfa8; border: 1px solid rgba(201,168,76,0.35); border-radius: 2px; font-family: 'IM Fell English', serif; }
    #individual-prayers-section {
        display: none;
        text-align: center;
        max-width: 800px;
        padding: 40px;
        width: 100%;
        margin: 0 auto; /* Center horizontally */
    }
    #prayer-selection { margin-bottom: 40px; }
    #prayer-display {
        background: var(--container-bg);
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        text-align: left;
        display: none;
        margin: 40px auto 0; /* Center horizontally with top margin */
        max-width: 800px;
        width: 100%;
    }
    #prayer-display .office-container {
        border-left: none; /* Remove left border for prayers mode */
    }
/* ============================================
   PRINT STYLES
   ============================================ */
@media print {
    /* Hide non-printable elements */
    #mode-selection,
    #settings-panel,
    .mode-btn,
    .ordo-control,
    .setting-group,
    #date-header,
    .saint-section {
        display: none !important;
    }
    /* Reset body styles for print */
    body {
        background: white !important;
        color: black !important;
        margin: 0;
        padding: 0;
        font-size: 12pt;
    }
    /* Main content takes full width */
    #main-content {
        margin-left: 0 !important;
        padding: 0.5in !important;
        width: 100% !important;
        max-width: 100% !important;
    }
    /* Office container clean for print */
    .office-container {
        background: white !important;
        box-shadow: none !important;
        border: none !important;
        padding: 0 !important;
        max-width: 100% !important;
        page-break-inside: avoid;
    }
    /* Typography optimized for print */
    h1 {
        font-size: 18pt;
        color: black !important;
        margin-bottom: 0.25in;
        page-break-after: avoid;
    }
    h2 {
        font-size: 14pt;
        color: black !important;
        border-bottom: 1px solid #333 !important;
        margin-top: 0.2in;
        page-break-after: avoid;
    }
    h3, h4 {
        font-size: 12pt;
        color: black !important;
        page-break-after: avoid;
    }
    /* Rubrics print in italic */
    .rubric-text {
        color: #333 !important;
        font-style: italic;
        font-size: 11pt;
        border-bottom: none !important;
        margin-top: 0.15in;
        page-break-after: avoid;
    }
    /* Passage references */
    .passage-reference {
        color: #666 !important;
        font-size: 10pt;
        font-style: italic;
    }
    /* Component text (prayers, readings) */
    .component-text {
        font-size: 11pt;
        line-height: 1.4;
        color: black !important;
        margin-bottom: 0.15in;
    }
    /* Psalm verses */
    .psalm-verse {
        font-size: 11pt;
        line-height: 1.5;
        margin-bottom: 0.1in;
    }
    .verse-num {
        color: #666 !important;
        font-size: 8pt;
    }
    /* Horizontal rules */
    hr {
        border: 0.5pt solid #999 !important;
        margin: 0.15in 0 !important;
    }
    /* Avoid breaking inside important sections */
    .rubric-text,
    .component-text,
    .psalm-verse {
        page-break-inside: avoid;
    }
    /* Page breaks before major sections */
    h2 {
        page-break-before: auto;
    }
    /* Links print as normal text */
    a {
        text-decoration: none;
        color: black !important;
    }
    /* Remove any remaining colored backgrounds */
    * {
        background: white !important;
    }
}
 </style>
</head>
<body id="app-body" class="dark-mode">
 <div id="splash-bg"></div>
 <div id="mode-selection">
     <h1>Welcome to The Universal Office</h1>
     <p>Select your mode:</p>
     <button class="mode-btn" onclick="selectMode('daily')">Daily Office</button>
     <button class="mode-btn" onclick="selectMode('prayers')">Individual Prayers</button>
 </div>
 <div id="daily-office-section">
     <div id="sidebar-toggle" onclick="toggleSidebar()">Settings</div>
     <div id="settings-panel">
         <button class="mode-btn" onclick="backToSplash()" style="margin-bottom:10px;">Back to Modes</button>
         <h3 style="color:var(--gold)">Office Settings</h3>
         <div class="ordo-control">
             <strong>Liturgical Ordo</strong>
             <div class="ordo-date" id="display-date">Loading...</div>
             <div class="ordo-buttons">
                 <button class="ordo-btn" onclick="changeDate(-1)">Prev</button>
                 <button class="ordo-btn" onclick="resetDate()">Today</button>
                 <button class="ordo-btn" onclick="changeDate(1)">Next</button>
             </div>
             <label for="date-picker" style="display:block; color:var(--gold); font-size:0.8em; margin-top:10px;">Select Date:</label>
             <input type="date" id="date-picker" style="margin-top:5px; width:100%; padding:5px; background:#333; color:white; border:1px solid #555; border-radius:4px; box-sizing: border-box;" onchange="setCustomDate(this.value)">
             <div id="calendar-info" style="font-size: 0.7em; color: var(--gold); margin-top:10px;">Exploring the Ordo...</div>
         </div>
         <div class="setting-group">
             <strong>Time of Day:</strong>
             <label><input type="radio" name="office-time" value="morning-office" onchange="renderOffice(); saveSettings()" checked> Morning Prayer</label>
             <label><input type="radio" name="office-time" value="noonday-office" onchange="renderOffice(); saveSettings()"> Noonday Prayer</label>
             <label><input type="radio" name="office-time" value="evening-office" onchange="renderOffice(); saveSettings()"> Evening Prayer</label>
             <label><input type="radio" name="office-time" value="compline-office" onchange="renderOffice(); saveSettings()"> Compline</label>
         </div>
         <div class="setting-group">
             <strong>Appearance:</strong>
             <label><input type="checkbox" id="toggle-dark" onchange="updateUI(); saveSettings()" checked> Dark Mode</label>
             <label style="margin-top:8px;"><input type="checkbox" id="toggle-bcp-only" onchange="toggleBcpOnly(); saveSettings()"> BCP Only Mode</label>
         </div>
         <div class="setting-group">
             <strong>Liturgical Settings:</strong>
             <div class="nested-group">
                 <strong style="color:#aaa; font-size:0.8em;">Language &amp; Rite</strong>
                 <label><input type="radio" name="rite" value="rite1" onchange="renderOffice(); saveSettings()"> Rite I (Traditional)</label>
                 <label><input type="radio" name="rite" value="rite2" onchange="renderOffice(); saveSettings()" checked> Rite II (Contemporary)</label>
             </div>
             <div class="nested-group" style="margin-top:8px;">
                 <strong style="color:#aaa; font-size:0.8em;">Officiant</strong>
                 <label><input type="radio" name="minister" value="priest" onchange="renderOffice(); saveSettings()"> Priest</label>
                 <label><input type="radio" name="minister" value="lay" onchange="renderOffice(); saveSettings()" checked> Layperson</label>
             </div>
             <div class="nested-group" style="margin-top:8px;">
                 <strong style="color:#aaa; font-size:0.8em;">Creed</strong>
                 <select id="creed-type" onchange="renderOffice(); saveSettings()" style="margin-top:4px; width:100%; padding:4px; background:#333; color:white; border:1px solid #555; border-radius:4px;">
                     <option value="bcp-creed-apostles">Apostles' Creed</option>
                     <option value="bcp-creed-nicene">Nicene Creed</option>
                 </select>
             </div>
             <div class="nested-group" style="margin-top:8px;">
                 <strong style="color:#aaa; font-size:0.8em;">Lectionary</strong>
                 <label style="margin-top:4px;"><input type="radio" name="gospel-placement" value="morning" onchange="renderOffice(); saveSettings()"> Gospel in Morning</label>
                 <label><input type="radio" name="gospel-placement" value="evening" onchange="renderOffice(); saveSettings()" checked> Gospel in Evening</label>
                 <label><input type="radio" name="gospel-placement" value="both" onchange="renderOffice(); saveSettings()"> Gospel in Both</label>
                 <label style="margin-top:6px;"><input type="checkbox" id="toggle-30day-psalter" onchange="renderOffice(); saveSettings()"> 30-Day Psalter</label>
             </div>
         </div>
         <div class="setting-group" id="ecumenical-devotions-section">
             <strong>Opening Devotions:</strong>
             <p style="font-size:0.75em; color:#888; margin:4px 0 8px 0; line-height:1.4;">Rendered before the office begins. Hidden in BCP Only Mode.</p>
             <div class="nested-group">
                 <strong style="color:#aaa; font-size:0.8em;">Coptic Orthodox</strong>
                 <label><input type="checkbox" id="toggle-agpeya-opening" onchange="renderOffice(); saveSettings()"> Agpeya Opening</label>
             </div>
             <div class="nested-group" style="margin-top:8px;">
                 <strong style="color:#aaa; font-size:0.8em;">Church of the East</strong>
                 <label><input type="checkbox" id="toggle-east-syriac-hours" onchange="renderOffice(); saveSettings()"> Prayer of the Hours <span style="color:#888; font-size:0.82em;">(Hudra)</span></label>
             </div>
             <div class="nested-group" style="margin-top:8px;">
                 <strong style="color:#aaa; font-size:0.8em;">Marian Element</strong>
                 <label style="margin-top:4px; font-size:0.85em; color:#aaa;">Element:</label>
                 <label><input type="radio" name="marian-element" value="none" onchange="renderOffice(); saveSettings()" checked> None</label>
                 <label><input type="radio" name="marian-element" value="antiphon" onchange="renderOffice(); saveSettings()"> BCP Seasonal Antiphon</label>
                 <label><input type="radio" name="marian-element" value="theotokion" onchange="renderOffice(); saveSettings()"> Theotokion <span style="color:#888; font-size:0.85em;">(Coptic)</span></label>
                 <label><input type="radio" name="marian-element" value="both" onchange="renderOffice(); saveSettings()"> Both</label>
                 <label style="margin-top:6px; font-size:0.85em; color:#aaa;">Position:</label>
                 <label><input type="radio" name="marian-antiphon-pos" value="before" onchange="renderOffice(); saveSettings()" checked> Before office</label>
                 <label><input type="radio" name="marian-antiphon-pos" value="after" onchange="renderOffice(); saveSettings()"> After office</label>
             </div>
         </div>
         <div class="setting-group" id="during-office-section">
             <strong>During the Office:</strong>
             <p style="font-size:0.75em; color:#888; margin:4px 0 8px 0; line-height:1.4;">Elements inserted at their liturgical position. Hidden in BCP Only Mode.</p>
             <label><input type="checkbox" id="toggle-gloria-patri" onchange="renderOffice(); saveSettings()" checked> Gloria Patri <span style="color:#888; font-size:0.82em;">(after Psalm)</span></label>
             <label style="margin-top:4px;"><input type="checkbox" id="toggle-angelus" onchange="renderOffice(); saveSettings()"> Angelus <span style="color:#888; font-size:0.82em;">(Catholic, before Invitatory)</span></label>
             <label><input type="checkbox" id="toggle-trisagion" onchange="renderOffice(); saveSettings()"> Trisagion <span style="color:#888; font-size:0.82em;">(Byzantine, after Absolution)</span></label>
             <label><input type="checkbox" id="toggle-prayer-before-reading" onchange="renderOffice(); saveSettings()"> Prayer Before Reading <span style="color:#888; font-size:0.82em;">(Orthodox, before OT Lesson)</span></label>
         </div>
         <div class="setting-group" id="closing-devotions-section">
             <strong>After the Office:</strong>
             <p style="font-size:0.75em; color:#888; margin:4px 0 8px 0; line-height:1.4;">Elements at the close. Hidden in BCP Only Mode.</p>
             <label><input type="checkbox" id="toggle-examen" onchange="renderOffice(); saveSettings()"> The Examen <span style="color:#888; font-size:0.82em;">(Ignatian, Compline only)</span></label>
             <label><input type="checkbox" id="toggle-kyrie-pantocrator" onchange="renderOffice(); saveSettings()"> Kyrie Pantocrator <span style="color:#888; font-size:0.82em;">(Byzantine, after Collect)</span></label>
             <label style="margin-top:6px;"><input type="checkbox" id="toggle-suffrages" onchange="renderOffice(); saveSettings()" checked> Suffrages</label>
             <label><input type="checkbox" id="toggle-litany" onchange="renderOffice(); saveSettings()"> The Great Litany</label>
             <label><input type="checkbox" id="toggle-general-thanksgiving" onchange="renderOffice(); saveSettings()"> General Thanksgiving</label>
             <label><input type="checkbox" id="toggle-chrysostom" onchange="renderOffice(); saveSettings()"> Prayer of St. Chrysostom</label>
         </div>
     </div>

     <div id="main-content">
         <h1>The Universal Office</h1>
         <div id="office-display"></div>
         <div class="saint-section">
             <div class="saint-section-divider"><div class="sdiv-left"></div><span>Commemorations</span><div class="sdiv-right"></div></div>
             <h2 id="date-header" style="display:none;"></h2>
             <div id="saint-display" class="saint-grid"></div>
         </div>
     </div>
 </div>
 <div id="individual-prayers-section">
    <div id="prayer-selection">  <!-- NEW: Wrapper JavaScript expects -->
        <h1>Individual Prayers</h1>
        <select id="prayer-dropdown" style="width: 300px; padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 4px;">
            <option value="">Select a Prayer</option>
            <option value="prayer-for-the-sick">Prayer for the Sick</option>
            <option value="prayer-for-peace">Prayer for Peace</option>
            <option value="prayer-for-unity">Prayer for Unity</option>
            <option value="prayer-for-mission">Prayer for Mission</option>
            <option value="prayer-for-guidance">Prayer for Guidance</option>
            <option value="prayer-for-the-church">Prayer for the Church</option>
            <option value="prayer-for-the-world">Prayer for the World</option>
        </select>
        <button class="mode-btn" onclick="showSinglePrayer()">Display Prayer</button>
        <button class="mode-btn" onclick="backToSplash()" style="margin-top:20px;">Back to Modes</button>
    </div>
    <div id="prayer-display" style="display:none; margin-top:40px; background: transparent; width: 100%;">  <!-- MOVED: Now inside section -->
        <div class="office-container" id="single-prayer-content"></div>
        <button class="mode-btn" onclick="backToPrayerDropdown()" style="margin-top:20px;">Back to Selection</button>
    </div>
</div>
<script src="js/calendar-engine.js"></script>
<script src="js/scripture-resolver.js"></script>
<script>
let appData = null;
let currentDate = new Date();
let selectedMode = null;
const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
const psalterCycle = [
{day: 1, morning: '1,2,3,4,5', evening: '6,7,8'},
{day: 2, morning: '9,10,11', evening: '12,13,14'},
{day: 3, morning: '15,16,17', evening: '18'},
{day: 4, morning: '19,20,21', evening: '22,23'},
{day: 5, morning: '24,25,26', evening: '27,28,29'},
{day: 6, morning: '30,31', evening: '32,33,34'},
{day: 7, morning: '35,36', evening: '37'},
{day: 8, morning: '38', evening: '39,40'},
{day: 9, morning: '41,42,43', evening: '44,45,46'},
{day: 10, morning: '47,48,49', evening: '50,51,52'},
{day: 11, morning: '53,54,55', evening: '56,57,58'},
{day: 12, morning: '59,60', evening: '61,62'},
{day: 13, morning: '63,64', evening: '65,66,67'},
{day: 14, morning: '68', evening: '69,70'},
{day: 15, morning: '71,72', evening: '73,74'},
{day: 16, morning: '75,76', evening: '77'},
{day: 17, morning: '78', evening: '79,80'},
{day: 18, morning: '81,82', evening: '83,84,85'},
{day: 19, morning: '86,87,88', evening: '89'},
{day: 20, morning: '90,91,92', evening: '93,94'},
{day: 21, morning: '95,96,97,98', evening: '99,100,101'},
{day: 22, morning: '102,103', evening: '104'},
{day: 23, morning: '105', evening: '106'},
{day: 24, morning: '107', evening: '108,109'},
{day: 25, morning: '110,111,112,113', evening: '114,115'},
{day: 26, morning: '116,117,118', evening: '119:1-32'},
{day: 27, morning: '119:33-72', evening: '119:73-104'},
{day: 28, morning: '119:105-144', evening: '119:145-176'},
{day: 29, morning: '120,121,122,123,124,125', evening: '126,127,128,129,130,131'},
{day: 30, morning: '132,133,134,135', evening: '136,137,138'},
{day: 31, morning: '139,140', evening: '141,142,143'}
];
function updateSeasonalTheme(color) {
let hex = '#4a7c59'; // Default to muted green for Ordinary
if (color === 'purple') hex = '#6b3070'; // Advent/Lent — deep Byzantine purple
if (color === 'rose') hex = '#a04060'; // Gaudete/Laetare — antique rose
if (color === 'white') hex = '#c9a84c'; // Christmas/Epiphany — use gold for white seasons
if (color === 'green') hex = '#4a7c59'; // Ordinary — forest green
if (color === 'red') hex = '#9b2335'; // Pentecost/Martyrs — deep crimson
document.documentElement.style.setProperty('--accent', hex);
}
async function init() {
   try {
       // Show loading state
       document.getElementById('office-display').innerHTML = `<div class="office-container"><h3>Loading...</h3><p>Preparing your daily office...</p></div>`;
       appData = {};
       const files = ['components', 'rubrics'];
       for (const file of files) {
           const res = await fetch(`data/${file}.json`);
           if (!res.ok) throw new Error(`Missing: data/${file}.json`);
           appData[file] = await res.json();
       }
       updateUI();
       await CalendarEngine.fetchLectionaryData();
       renderOffice();
   } catch (err) {
       document.getElementById('office-display').innerHTML = `<div class="office-container"><h3>System Error</h3><p>${err.message}</p></div>`;
       console.error('Init failed:', err);
   }
}
function selectMode(mode) {
   selectedMode = mode;
   document.getElementById('mode-selection').style.display = 'none';
   document.getElementById('splash-bg').style.display = 'none';
   document.body.classList.add('office-active');
   document.body.style.height = 'auto';
   document.body.style.overflowY = 'auto';
  if (mode === 'daily') {
        document.body.style.display = 'flex';
        document.body.style.justifyContent = 'flex-start';
        document.body.style.alignItems = 'flex-start';
        document.getElementById('daily-office-section').style.display = 'flex';
        loadSettings(); // Load saved preferences
        updateDatePicker();
        // Initialize data only when Daily Office is selected
        if (!appData || !appData.rubrics) {
            init();
        } else {
            renderOffice();
        }
    } else if (mode === 'prayers') {
       document.body.style.display = 'block';
       document.body.style.width = '100vw';
       document.body.style.maxWidth = '100vw';
       document.body.style.margin = '0';
       document.body.style.padding = '0';
       document.getElementById('individual-prayers-section').style.display = 'flex';
       document.getElementById('individual-prayers-section').style.width = '100vw';
       document.getElementById('sidebar-toggle').style.display = 'none';
       document.getElementById('settings-panel').style.display = 'none';
   }
}
function changeDate(days) {
 currentDate.setDate(currentDate.getDate() + days);
 updateDatePicker();
 renderOffice();
}
function resetDate() {
 currentDate = new Date();
 updateDatePicker();
 renderOffice();
}
function updateDatePicker() {
 const year = currentDate.getFullYear();
 const month = String(currentDate.getMonth() + 1).padStart(2, '0');
 const day = String(currentDate.getDate()).padStart(2, '0');
 const dateStr = `${year}-${month}-${day}`;
 const picker = document.getElementById('date-picker');
 if (picker) picker.value = dateStr;
}
function setCustomDate(dateStr) {
 if (dateStr) {
   // Parse date string as local time to avoid timezone shifting
   const [year, month, day] = dateStr.split('-');
   currentDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
 }
 updateDatePicker();
 renderOffice();
}
function toggleSidebar() {
   const panel = document.getElementById('settings-panel');
   const toggle = document.getElementById('sidebar-toggle');
   const main = document.getElementById('main-content');
   const hidden = panel.classList.toggle('sidebar-hidden');
   toggle.classList.toggle('sidebar-hidden', hidden);
   if (main) main.classList.toggle('sidebar-hidden', hidden);
}
function toggleBcpOnly() {
   const bcpOnly = document.getElementById('toggle-bcp-only')?.checked || false;
   const sections = ['ecumenical-devotions-section','during-office-section','closing-devotions-section']
      .map(id => document.getElementById(id)).filter(Boolean);
   if (!sections.length) return;
   if (bcpOnly) {
      sections.forEach(s => s.classList.add('bcp-only-hidden'));
      ['toggle-angelus','toggle-trisagion','toggle-east-syriac-hours','toggle-agpeya-opening',
       'toggle-prayer-before-reading','toggle-examen','toggle-kyrie-pantocrator'].forEach(id => {
         const el = document.getElementById(id);
         if (el) el.checked = false;
      });
   } else {
      sections.forEach(s => s.classList.remove('bcp-only-hidden'));
   }
   renderOffice();
}
function updateUI() {
  const isDark = document.getElementById('toggle-dark')?.checked || false;
  if (isDark) document.body.classList.add('dark-mode');
  else document.body.classList.remove('dark-mode');
}
function saveSettings() {
   const settings = {
      darkMode: document.getElementById('toggle-dark')?.checked || false,
      bcpOnly: document.getElementById('toggle-bcp-only')?.checked || false,
      officeTime: document.querySelector('input[name="office-time"]:checked')?.value || 'morning-office',
      rite: document.querySelector('input[name="rite"]:checked')?.value || 'rite2',
      minister: document.querySelector('input[name="minister"]:checked')?.value || 'lay',
      marianElement: document.querySelector('input[name="marian-element"]:checked')?.value || 'none',
      marianPos: document.querySelector('input[name="marian-antiphon-pos"]:checked')?.value || 'before',
      gloriaPatri: document.getElementById('toggle-gloria-patri')?.checked || false,
      angelus: document.getElementById('toggle-angelus')?.checked || false,
      trisagion: document.getElementById('toggle-trisagion')?.checked || false,
      eastSyriacHours: document.getElementById('toggle-east-syriac-hours')?.checked || false,
      agpeyaOpening: document.getElementById('toggle-agpeya-opening')?.checked || false,
      creedType: document.getElementById('creed-type')?.value || 'bcp-creed-apostles',
      gospelPlacement: document.querySelector('input[name="gospel-placement"]:checked')?.value || 'evening',
      litany: document.getElementById('toggle-litany')?.checked || false,
      suffrages: document.getElementById('toggle-suffrages')?.checked || false,
      psalter30Day: document.getElementById('toggle-30day-psalter')?.checked || false,
      generalThanksgiving: document.getElementById('toggle-general-thanksgiving')?.checked || false,
      chrysostom: document.getElementById('toggle-chrysostom')?.checked || false,
      prayerBeforeReading: document.getElementById('toggle-prayer-before-reading')?.checked || false,
      examen: document.getElementById('toggle-examen')?.checked || false,
      kyriePantocrator: document.getElementById('toggle-kyrie-pantocrator')?.checked || false
   };
   try {
      localStorage.setItem('universalOfficeSettings', JSON.stringify(settings));
      console.log('Settings saved');
   } catch (e) {
      console.warn('Could not save settings to localStorage:', e);
   }
}
function loadSettings() {
   try {
      const saved = localStorage.getItem('universalOfficeSettings');
      if (!saved) return;
      const settings = JSON.parse(saved);
      // Restore checkboxes and radios
      if (document.getElementById('toggle-dark')) document.getElementById('toggle-dark').checked = settings.darkMode;
      if (settings.bcpOnly && document.getElementById('toggle-bcp-only')) {
         document.getElementById('toggle-bcp-only').checked = true;
         toggleBcpOnly();
      }
      const officeTimeRadio = document.querySelector(`input[name="office-time"][value="${settings.officeTime}"]`);
      if (officeTimeRadio) officeTimeRadio.checked = true;
      const riteRadio = document.querySelector(`input[name="rite"][value="${settings.rite}"]`);
      if (riteRadio) riteRadio.checked = true;
      const ministerRadio = document.querySelector(`input[name="minister"][value="${settings.minister}"]`);
      if (ministerRadio) ministerRadio.checked = true;
      const marianElementRadio = document.querySelector(`input[name="marian-element"][value="${settings.marianElement}"]`);
      if (marianElementRadio) marianElementRadio.checked = true;
      const marianPosRadio = document.querySelector(`input[name="marian-antiphon-pos"][value="${settings.marianPos}"]`);
      if (marianPosRadio) marianPosRadio.checked = true;
      if (document.getElementById('toggle-gloria-patri')) document.getElementById('toggle-gloria-patri').checked = settings.gloriaPatri;
      if (document.getElementById('toggle-angelus')) document.getElementById('toggle-angelus').checked = settings.angelus;
      if (document.getElementById('toggle-trisagion')) document.getElementById('toggle-trisagion').checked = settings.trisagion;
      if (document.getElementById('toggle-east-syriac-hours')) document.getElementById('toggle-east-syriac-hours').checked = settings.eastSyriacHours;
      if (document.getElementById('toggle-agpeya-opening')) document.getElementById('toggle-agpeya-opening').checked = settings.agpeyaOpening;
      if (document.getElementById('creed-type')) document.getElementById('creed-type').value = settings.creedType;
      const gospelRadio = document.querySelector(`input[name="gospel-placement"][value="${settings.gospelPlacement}"]`);
      if (gospelRadio) gospelRadio.checked = true;
      if (document.getElementById('toggle-litany')) document.getElementById('toggle-litany').checked = settings.litany;
      if (document.getElementById('toggle-suffrages')) document.getElementById('toggle-suffrages').checked = settings.suffrages;
      if (document.getElementById('toggle-30day-psalter')) document.getElementById('toggle-30day-psalter').checked = settings.psalter30Day;
      if (document.getElementById('toggle-general-thanksgiving')) document.getElementById('toggle-general-thanksgiving').checked = settings.generalThanksgiving;
      if (document.getElementById('toggle-chrysostom')) document.getElementById('toggle-chrysostom').checked = settings.chrysostom;
      if (document.getElementById('toggle-prayer-before-reading')) document.getElementById('toggle-prayer-before-reading').checked = settings.prayerBeforeReading;
      if (document.getElementById('toggle-examen')) document.getElementById('toggle-examen').checked = settings.examen;
      if (document.getElementById('toggle-kyrie-pantocrator')) document.getElementById('toggle-kyrie-pantocrator').checked = settings.kyriePantocrator;
      console.log('Settings loaded');
   } catch (e) {
      console.warn('Could not load settings from localStorage:', e);
   }
}
function formatScriptureAsFlow(rawText) {
    if (!rawText) return '';
    // Remove verse number prefixes like "12:1 " or "1:1 "
    let cleaned = rawText.replace(/^\d+:\d+\s/gm, '').trim();
    // Split on double newlines (paragraph breaks between passages)
    let paragraphs = cleaned.split(/\n\n+/).filter(p => p.trim());
    return paragraphs.map(para => {
        // Within each paragraph, join single newlines into flowing text
        let flowing = para.split('\n').map(l => l.trim()).filter(l => l).join(' ');
        return `<p>${flowing}</p>`;
    }).join('');
}

function formatPsalmAsPoetry(rawText) {
    if (!rawText) return '';
    let cleaned = rawText.replace(/^\d+:\d+\s/gm, '').trim();
    let lines = cleaned.split('\n').filter(l => l.trim());
    let html = '';
    for (let line of lines) {
        // Psalm verses often have a mid-verse break marked by * or ; — treat as half-verse indent
        const halves = line.split(/\s*[*]\s*/);
        if (halves.length > 1) {
            html += `<span class="psalm-stanza">`;
            html += `<span class="psalm-half-verse">${halves[0].trim()}</span>`;
            html += `<span class="psalm-half-verse">${halves[1].trim()}</span>`;
            html += `</span>`;
        } else {
            html += `<span class="psalm-stanza"><span class="psalm-half-verse">${line.trim()}</span></span>`;
        }
    }
    return html;
}

async function renderOffice() {
   if (!appData || !appData.rubrics || !Array.isArray(appData.rubrics)) {
       document.getElementById('office-display').innerHTML = `<div class="office-container"><h3>Loading...</h3><p>Data still loading.</p></div>`;
       return;
   }
   // Show brief loading state while rendering (especially helpful when fetching scripture)
   document.getElementById('office-display').innerHTML = `<div class="office-container"><h3>Loading Office...</h3><p>Fetching readings...</p></div>`;
  const todayKey = currentDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
const todayKeyShort = currentDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
  document.getElementById('display-date').innerText = todayKey;
  const officeId = document.querySelector('input[name="office-time"]:checked')?.value;
  const rite = document.querySelector('input[name="rite"]:checked')?.value || 'rite2';
   const minister = document.querySelector('input[name="minister"]:checked')?.value || 'lay';
  const marianElement = document.querySelector('input[name="marian-element"]:checked')?.value || 'none';
  const marianPos = document.querySelector('input[name="marian-antiphon-pos"]:checked')?.value || 'before';
  const creedSelection = document.getElementById('creed-type')?.value;
  const greatLitanyChecked = document.getElementById('toggle-litany')?.checked || false;
  const suffragesChecked = document.getElementById('toggle-suffrages')?.checked || false;
  const gospelPlacement = document.querySelector('input[name="gospel-placement"]:checked')?.value || 'evening';
  const generalThanksgivingChecked = document.getElementById('toggle-general-thanksgiving')?.checked || false;
  const chrysostomChecked = document.getElementById('toggle-chrysostom')?.checked || false;
  // Ecumenical devotions rendered positionally — no array needed

  const { season } = CalendarEngine.getSeasonAndFile(currentDate);
  const marianId = `bcp-marian-antiphon-${season}`;
  const marianComp = appData.components.find(c => c.id === marianId);
  const theotokionComp = appData.components.find(c => c.id === 'coptic-theotokion');
  const activeRubric = appData.rubrics.find(r => r.id === officeId);
  const dailyData = await CalendarEngine.fetchLectionaryData(currentDate);
  document.getElementById('calendar-info').innerText = dailyData.title || "Liturgical Ordo";
  updateSeasonalTheme(dailyData.liturgicalColor || 'green');
  const isMorning = officeId === 'morning-office';
  const isEvening = officeId === 'evening-office';
  const isNoonday = officeId === 'noonday-office';
  const isCompline = officeId === 'compline-office';
  const suffix = isEvening || isCompline ? '_evening' : '_morning';
  let psalms = dailyData[`psalms${suffix}`] || "";
  const use30Day = document.getElementById('toggle-30day-psalter')?.checked || false;
  if (use30Day) {
    const dayOfMonth = currentDate.getDate();
    const psalterDay = (dayOfMonth % 30) || 30;
    psalms = psalterCycle[psalterDay - 1][isEvening || isCompline ? 'evening' : 'morning'];
  }
  // Lesson distribution based on placement with fallback to old keys
  const litYear = CalendarEngine.getLiturgicalYear(currentDate);

// Priority 1: Year-specific keys (e.g., reading_ot_mp_year2)
// Priority 2: Standard keys (reading_ot)
let readingOT = dailyData[`reading_ot_mp_${litYear}`] || dailyData[`reading_ot_ep_${litYear}`] || dailyData['reading_ot'] || "";
let readingEpistle = dailyData[`reading_epistle_mp_${litYear}`] || dailyData[`reading_epistle_ep_${litYear}`] || dailyData['reading_epistle'] || "";
let readingGospel = dailyData[`reading_gospel_mp_${litYear}`] || dailyData[`reading_gospel_ep_${litYear}`] || dailyData['reading_gospel'] || "";
   // Morning Prayer readings
   let morningOT = isMorning ? readingOT : '';
   let morningEpistle = isMorning ? readingEpistle : '';
   let morningGospel = (isMorning && (gospelPlacement === 'morning' || gospelPlacement === 'both')) ? readingGospel : '';
   // Evening/Noonday/Compline readings - always show OT and Epistle
   let eveningOT = (isEvening || isCompline || isNoonday) ? readingOT : '';
   let eveningEpistle = (isEvening || isCompline || isNoonday) ? readingEpistle : '';
   let eveningGospel = ((isEvening || isCompline || isNoonday) && (gospelPlacement === 'evening' || gospelPlacement === 'both')) ? readingGospel : '';
  let officeHtml = `<div class="office-container"><h2>${activeRubric?.officeName || "Office"}</h2>`;
  officeHtml += `<p class="liturgical-title">${dailyData.title || "Day Title"}</p>`;
  // AGPEYA OPENING — Coptic preparation prayer, rendered before all else
  if (document.getElementById('toggle-agpeya-opening')?.checked) {
    const agpeyaComp = appData.components.find(c => c.id === 'agpeya-opening');
    if (agpeyaComp) {
      let agpeyaText = agpeyaComp.text;
      if (typeof agpeyaText === 'object') agpeyaText = agpeyaText[rite] || agpeyaText['rite2'] || agpeyaText['rite1'] || agpeyaText;
      officeHtml += `<span class="rubric-text">Agpeya Opening</span><span class="component-text">${agpeyaText}</span>`;
    }
  }
  // EAST SYRIAC PRAYER OF THE HOURS (Hudra) — consecration of the hour, after Agpeya
  if (document.getElementById('toggle-east-syriac-hours')?.checked) {
    const esComp = appData.components.find(c => c.id === 'east-syriac-prayer-of-hours');
    if (esComp) {
      officeHtml += `<span class="rubric-text">Prayer of the Hours</span><span class="component-text">${esComp.text}</span>`;
    }
  }
  if (marianElement !== 'none' && marianPos === 'before') {
    if ((marianElement === 'antiphon' || marianElement === 'both') && marianComp) {
      let marianText = marianComp.text;
      if (typeof marianText === 'object' && marianText !== null) {
        marianText = marianText[rite] || marianText['rite2'] || marianText['rite1'] || 'Marian Antiphon text not found';
      }
      officeHtml += `<span class="rubric-text">Marian Antiphon</span><span class="component-text"><i>${marianText}</i></span>`;
    }
    if ((marianElement === 'theotokion' || marianElement === 'both') && theotokionComp) {
      officeHtml += `<span class="rubric-text">Theotokion</span><span class="component-text"><i>${theotokionComp.text}</i></span>`;
    }
  }
  if (dailyData.antiphon) {
    officeHtml += `<span class="rubric-text">Antiphon</span><span class="component-text"><i>${dailyData.antiphon}</i></span>`;
  }
  for (let item of activeRubric?.sequence || []) {
 item = item.trim(); // Trim for matching
  const originalItem = item; // Preserve before compId resolution
 let compId = item.replace('[rite]', rite); // Replace placeholders like bcp-confession-[rite]
 // Handle slots like bcp-absolution-slot, bcp-creed-slot, bcp-suffrages-slot
 if (compId === "bcp-absolution-slot") {
   const ritePrefix = rite === 'rite1' ? 'r1' : 'r2';
   compId = `bcp-absolution-${ritePrefix}-${minister}`;
 } else if (compId === "bcp-creed-slot") {
   compId = creedSelection;
 } else if (compId === "bcp-suffrages-slot") {
   if (suffragesChecked) {
     compId = `bcp-suffrages-${rite}`;
   } else {
     continue; // Skip if unchecked
   }
  }
 if (item === "VARIABLE_OPENING") {
   let openingId = `bcp-opening-${season}`; // Seasonal, e.g., bcp-opening-advent
   const comp = appData.components.find(c => c.id === openingId) || appData.components.find(c => c.id === 'bcp-opening-general'); // Fallback
   let displayText = comp ? (comp.text[rite] || comp.text) : "Opening text not found";
   officeHtml += `<span class="rubric-text">Opening Sentence</span><span class="component-text">${displayText}</span>`;
   continue;
 }
 // ANGELUS — before Invitatory (Noonday always; MP/EP optional; not Compline)
 if (item === 'bcp-invitatory-full' && document.getElementById('toggle-angelus')?.checked && !isCompline) {
   const angelusComp = appData.components.find(c => c.id === 'angelus');
   if (angelusComp) {
     let angelusText = angelusComp.text;
     if (typeof angelusText === 'object') angelusText = angelusText[rite] || angelusText['rite2'] || angelusText['rite1'] || angelusText;
     officeHtml += `<span class="rubric-text">The Angelus</span><span class="component-text">${angelusText}</span>`;
   }
 }
 if (item === "bcp-invitatory-full") {
   let invitatoryId = isMorning ? 'bcp-invitatory-full-mp' : 'bcp-invitatory-full-ep-noon-compline';
   const comp = appData.components.find(c => c.id === invitatoryId);
   let displayText = comp ? (comp.text[rite] || comp.text) : "Invitatory text not found";
   officeHtml += `<span class="rubric-text">The Invitatory</span><span class="component-text">${displayText}</span>`;
   continue;
 }
 if (item === "bcp-phos-hilaron") {
   const comp = appData.components.find(c => c.id === "bcp-phos-hilaron");
   let displayText = comp ? (comp.text[rite] || comp.text) : "Phos Hilaron not found";
   officeHtml += `<span class="rubric-text">Phos Hilaron</span><span class="component-text">${displayText}</span>`;
   continue;
 }
 if (item === "VARIABLE_PSALM") {
   if (psalms) {
     let psalmRefs = psalms.split(',').map(p => p.trim());
     let psalmHtml = "";
     const rubricTitle = psalmRefs.length > 1 ? "The Psalms" : "The Psalm";
     psalmHtml += `<span class="rubric-text">${rubricTitle}</span>`;
     for (let psalm of psalmRefs) {
       let psalmId = psalm.toUpperCase().trim();
       if (!psalmId.startsWith('PSALM ')) psalmId = 'PSALM ' + psalmId;
       const fullText = await getScriptureText(psalmId);
       psalmHtml += `<h4 class="passage-reference">Psalm ${psalm.replace(/Psalm /gi, '').replace(/:\d+-\d+[a-z]?(\(\d+-\d+[a-z]?\))?/gi, '')}</h4><div class="psalm-block">${formatPsalmAsPoetry(fullText) || "No psalm text found"}</div>`;
       if (document.getElementById('toggle-gloria-patri')?.checked) {
         const gloria = appData.components.find(c => c.id === "bcp-gloria-patri");
         let gloriaText = gloria ? (gloria.text[rite] || gloria.text['rite2'] || "(Gloria Patri)") : "(Gloria Patri not found)";
         psalmHtml += `<span class="component-text"><i>${gloriaText}</i></span>`;
       }
     }
     officeHtml += psalmHtml;
   }
   continue;
 }
 if (item === "VARIABLE_READING_OT") {
    // PRAYER BEFORE READING — Orthodox epiklesis, before the lesson
    if (document.getElementById('toggle-prayer-before-reading')?.checked) {
      const pbrComp = appData.components.find(c => c.id === 'orthodox-prayer-before-reading');
      if (pbrComp) officeHtml += `<span class="rubric-text">Prayer Before Reading</span><span class="component-text">${pbrComp.text}</span>`;
    }
   let reading = isMorning ? morningOT : eveningOT;
   if (reading) {
     officeHtml += `<span class="rubric-text">The Old Testament Lesson</span>`;
     officeHtml += `<h4 class="passage-reference">${reading}</h4>`;
     const fullText = await getScriptureText(reading);
     officeHtml += `<div class="reading-text">${formatScriptureAsFlow(fullText) || "<p>No reading appointed</p>"}</div>`;
     officeHtml += '<div class="ornamental-divider"><div class="div-line-left"></div><span class="ornamental-divider-glyph">✦ ✝ ✦</span><div class="div-line-right"></div></div>';
   }
   continue;
 }
 if (item === "VARIABLE_READING_EPISTLE") {
   let reading = isMorning ? morningEpistle : eveningEpistle;
   if (reading) {
     officeHtml += `<span class="rubric-text">The Epistle</span>`;
     officeHtml += `<h4 class="passage-reference">${reading}</h4>`;
     const fullText = await getScriptureText(reading);
     officeHtml += `<div class="reading-text">${formatScriptureAsFlow(fullText) || "<p>No reading appointed</p>"}</div>`;
     officeHtml += '<div class="ornamental-divider"><div class="div-line-left"></div><span class="ornamental-divider-glyph">✦ ✝ ✦</span><div class="div-line-right"></div></div>';
   }
   continue;
 }
 if (item === "VARIABLE_READING_GOSPEL") {
   let reading = isMorning ? morningGospel : eveningGospel;
   if (reading) {
     officeHtml += `<span class="rubric-text">The Holy Gospel</span>`;
     officeHtml += `<h4 class="passage-reference">${reading}</h4>`;
     const fullText = await getScriptureText(reading);
     officeHtml += `<div class="reading-text">${formatScriptureAsFlow(fullText) || "<p>No reading appointed</p>"}</div>`;
     officeHtml += '<div class="ornamental-divider"><div class="div-line-left"></div><span class="ornamental-divider-glyph">✦ ✝ ✦</span><div class="div-line-right"></div></div>';
   }
   continue;
 }
 if (item === "VARIABLE_CANTICLE1") {
   let canticleId = isMorning ? 'bcp-te-deum' : 'bcp-magnificat'; // Default per office
   const comp = appData.components.find(c => c.id === canticleId);
   let displayText = comp ? (comp.text[rite] || comp.text) : "Canticle not found";
   officeHtml += `<span class="rubric-text">Canticle</span><span class="component-text">${displayText}</span>`;
   continue;
 }
 if (item === "VARIABLE_CANTICLE2") {
   let canticleId = isMorning ? 'bcp-benedictus' : 'bcp-nunc-dimittis';
   const comp = appData.components.find(c => c.id === canticleId);
   let displayText = comp ? (comp.text[rite] || comp.text) : "Canticle not found";
   officeHtml += `<span class="rubric-text">Canticle</span><span class="component-text">${displayText}</span>`;
   continue;
 }
 if (item === "bcp-lords-prayer") {
   const comp = appData.components.find(c => c.id === "bcp-lords-prayer");
   let displayText = comp ? (comp.text[rite] || comp.text) : "Lord's Prayer not found";
   officeHtml += `<span class="rubric-text">The Lord's Prayer</span><span class="component-text">${displayText}</span>`;
   continue;
 }
 if (item === "bcp-kyrie") {
   const comp = appData.components.find(c => c.id === "bcp-kyrie");
   let displayText = comp ? (comp.text[rite] || comp.text) : "Kyrie not found";
   officeHtml += `<span class="rubric-text">Kyrie</span><span class="component-text">${displayText}</span>`;
   continue;
 }
 if (item === "bcp-salutation") {
   const comp = appData.components.find(c => c.id === "bcp-salutation");
   let displayText = comp ? (comp.text[rite] || comp.text) : "Salutation not found";
   officeHtml += `<span class="rubric-text">Salutation</span><span class="component-text">${displayText}</span>`;
   continue;
 }
 if (item === "VARIABLE_WEEKDAY_COLLECT") {
   let collectId = isMorning ? 'bcp-collect-grace' : 'bcp-collect-peace'; // MP/EP defaults
   const comp = appData.components.find(c => c.id === collectId);
   let displayText = comp ? (comp.text[rite] || comp.text) : "Weekday Collect not found";
   officeHtml += `<span class="rubric-text">Weekday Collect</span><span class="component-text">${displayText}</span>`;
   continue;
 }
 if (item === "VARIABLE_MISSION_PRAYER") {
   const comp = appData.components.find(c => c.id === "bcp-mission-prayer-1"); // Default option 1
   let displayText = comp ? (comp.text[rite] || comp.text) : "Prayer for Mission not found";
   officeHtml += `<span class="rubric-text">Prayer for Mission</span><span class="component-text">${displayText}</span>`;
   continue;
 }
 if (item === "bcp-litany") {
   if (greatLitanyChecked) {
     const comp = appData.components.find(c => c.id === "bcp-litany");
     let displayText = comp ? (comp.text[rite] || comp.text) : "Great Litany not found";
     officeHtml += `<span class="rubric-text">The Great Litany</span><span class="component-text">${displayText}</span>`;
   }
   continue;
 }
 if (item === "bcp-general-thanksgiving") {
   if (generalThanksgivingChecked) {
     const comp = appData.components.find(c => c.id === "bcp-general-thanksgiving");
     let displayText = comp ? (comp.text[rite] || comp.text) : "General Thanksgiving not found";
     officeHtml += `<span class="rubric-text">General Thanksgiving</span><span class="component-text">${displayText}</span>`;
   }
   continue;
 }
 if (item === "bcp-chrysostom") {
   if (chrysostomChecked) {
     const comp = appData.components.find(c => c.id === "bcp-chrysostom");
     let displayText = comp ? (comp.text[rite] || comp.text) : "Prayer of St. Chrysostom not found";
     officeHtml += `<span class="rubric-text">Prayer of St. Chrysostom</span><span class="component-text">${displayText}</span>`;
   }
   continue;
 }
 if (item === "bcp-closing") {
   const comp = appData.components.find(c => c.id === "bcp-closing");
   let displayText = comp ? (comp.text[rite] || comp.text) : "Closing not found";
   officeHtml += `<span class="rubric-text">Closing</span><span class="component-text">${displayText}</span>`;
   continue;
 }
 if (item === "bcp-opening-blessing") {
   const comp = appData.components.find(c => c.id === "bcp-opening-blessing-compline");
   let displayText = comp ? (comp.text[rite] || comp.text) : "Opening Blessing not found";
   officeHtml += `<span class="rubric-text">Opening Blessing</span><span class="component-text">${displayText}</span>`;
   continue;
 }
 if (item === "bcp-versicles-before-prayers") {
   const comp = appData.components.find(c => c.id === "bcp-versicles-before-prayers-compline");
   let displayText = comp ? (comp.text[rite] || comp.text) : "Versicles not found";
   officeHtml += `<span class="rubric-text">Versicles</span><span class="component-text">${displayText}</span>`;
   continue;
 }
 if (item === "bcp-nunc-dimittis") {
   const comp = appData.components.find(c => c.id === "bcp-nunc-dimittis");
   let displayText = comp ? (comp.text[rite] || comp.text) : "Nunc Dimittis not found";
   officeHtml += `<span class="rubric-text">Nunc Dimittis</span><span class="component-text">${displayText}</span>`;
   continue;
 }
 if (item === "VARIABLE_COLLECT") {
   officeHtml += `<span class="rubric-text">The Collect</span>`;
   const collectId = dailyData.collect || "collect-default-ferial"; // Fallback to default if missing
   const collectComp = appData.components.find(c => c.id === collectId);
   if (collectComp) {
     let displayText = collectComp.text;
     if (typeof displayText === 'object' && displayText !== null) {
       displayText = displayText[rite] || displayText['rite2'] || displayText['rite1'] || "Collect text not found";
     } else {
       displayText = displayText || "Collect text not found";
     }
     officeHtml += `<span class="component-text">${displayText}</span>`;
   } else {
     officeHtml += `<span class="component-text">No collect appointed</span>`;
     console.log("Collect ID not found: " + collectId); // Debug log
   }
   officeHtml += '<div class="ornamental-divider"><div class="div-line-left"></div><span class="ornamental-divider-glyph">✦ ✝ ✦</span><div class="div-line-right"></div></div>';
    // EXAMEN — Compline only, after Collect
    if (isCompline && document.getElementById('toggle-examen')?.checked) {
      const examenComp = appData.components.find(c => c.id === 'ignatian-examen');
      if (examenComp) officeHtml += `<span class="rubric-text">The Examen</span><span class="component-text">${examenComp.text}</span>`;
    }
    // KYRIE PANTOCRATOR — MP/EP only, after Collect
    if (!isCompline && !isNoonday && document.getElementById('toggle-kyrie-pantocrator')?.checked) {
      const kyrieComp = appData.components.find(c => c.id === 'eastern-kyrie-pantocrator');
      if (kyrieComp) officeHtml += `<span class="rubric-text">Kyrie Pantocrator</span><span class="component-text">${kyrieComp.text}</span>`;
    }
   continue;
  }
 let comp = appData.components.find(c => c.id === compId);
 if (comp) {
   let displayText = comp.text;
   if (typeof displayText === 'object' && displayText !== null) {
     displayText = displayText[rite] || displayText['rite2'] || displayText['rite1'] || "Text not found";
   } else {
     displayText = displayText || "Text not found";
   }
   officeHtml += `<span class="rubric-text">${comp.title || compId}</span><span class="component-text">${displayText}</span>`;
 } else {
   officeHtml += `<span class="rubric-text">Component not found: ${compId}</span>`;
 }
  // TRISAGION — rendered after Absolution
  if (item === 'bcp-absolution-slot' && document.getElementById('toggle-trisagion')?.checked) {
    const trisComp = appData.components.find(c => c.id === 'trisagion-byzantine');
    if (trisComp) {
      let trisText = trisComp.text;
      if (typeof trisText === 'object') trisText = trisText[rite] || trisText['rite2'] || trisText['rite1'] || trisText;
      officeHtml += `<span class="rubric-text">Trisagion</span><span class="component-text">${trisText}</span>`;
    }
  }
}
   if (marianElement !== 'none' && marianPos === 'after') {
     if ((marianElement === 'antiphon' || marianElement === 'both') && marianComp) {
       let marianText = marianComp.text;
       if (typeof marianText === 'object' && marianText !== null) {
         marianText = marianText[rite] || marianText['rite2'] || marianText['rite1'] || 'Marian Antiphon text not found';
       }
       officeHtml += `<span class="rubric-text">Marian Antiphon</span><span class="component-text"><i>${marianText}</i></span>`;
     }
     if ((marianElement === 'theotokion' || marianElement === 'both') && theotokionComp) {
       officeHtml += `<span class="rubric-text">Theotokion</span><span class="component-text"><i>${theotokionComp.text}</i></span>`;
     }
   }
 document.getElementById('office-display').innerHTML = officeHtml + `</div>`;
 document.getElementById('date-header').innerText = `Commemorations for ${todayKey}`;
 const todayKeyLower = todayKey.toLowerCase();
 // Dynamically load saints for the current month
 const monthIndex = currentDate.getMonth();
 const month = monthNames[monthIndex];
 if (!appData.saints || appData.saintsMonth !== month) {
   try {
     const file = `saints-${month.toLowerCase()}.json`;
     const res = await fetch(`data/saints/${file}`);
     if (!res.ok) throw new Error(`Failed to load ${file}`);
     appData.saints = await res.json();
     appData.saintsMonth = month;
   } catch (err) {
     console.error('Saints load failed:', err);
     document.getElementById('saint-display').innerHTML = '<p>No commemorations for today.</p>';
     return;
   }
 }
 document.getElementById('saint-display').innerHTML = appData.saints
     .filter(s => s.day && s.day.toLowerCase().includes(todayKeyShort.toLowerCase()))
     .map(s => `
         <div class="saint-box">
             <small style="color:var(--accent); font-weight:bold; text-transform:uppercase;">${s.tradition || 'Unknown'}</small>
             <strong>${s.name || 'Unknown'}</strong>
             <p>${s.description || 'No description'}</p>
         </div>
     `).join('') || '<p>No commemorations for today.</p>';
}
function showSinglePrayer() {
  const prayerId = document.getElementById('prayer-dropdown').value;
  if (!prayerId) {
      alert("Please select a prayer first.");
      return;
  }
  const prayers = {
      "prayer-for-the-sick": "O Father of mercies, and God of all comfort, our only help in time of need: We humbly beseech thee to behold, visit, and relieve thy sick servant [Name] for whom our prayers are desired. Look upon him with the eyes of thy mercy; comfort him with a sense of thy goodness; preserve him from the temptations of the enemy; and give him patience under his affliction. In thy good time, restore him to health, and enable him to lead the residue of his life in thy fear, and to thy glory; and grant that finally he may dwell with thee in life everlasting; through Jesus Christ our Lord. Amen.",
      "prayer-for-peace": "O God, the source of all holy desires, all good counsels, and all just works: Give to thy servants that peace which the world cannot give; that our hearts may be set to obey thy commandments, and also that by thee, we, being defended from the fear of our enemies, may pass our time in rest and quietness; through the merits of Jesus Christ our Savior. Amen.",
      "prayer-for-unity": "O God the Father of our Lord Jesus Christ, in whom thou art well pleased, grant, we beseech thee, that being knit together in the same mind and in the same judgment, we may all speak the same thing, and be of one accord, of one mind, and that there be no divisions among us; but that we be perfectly joined together in the same mind and in the same judgment. Amen.",
      "prayer-for-mission": "Lord Jesus Christ, who didst stretch out thy loving arms on the hard wood of the Cross that everyone might come within the reach of thy saving embrace: So clothe us in thy Spirit that we, reaching forth our hands in love, may bring those who do not know thee to the knowledge and love of thee; for the honor of thy Name. Amen.",
      "prayer-for-guidance": "O God, by whom the meek are guided in judgment, and light riseth up in darkness for the godly: Grant us, in all our doubts and uncertainties, the grace to ask what thou wouldest have us to do, that the Spirit of wisdom may save us from all false choices; that we may find the right path, and walk in it; through Jesus Christ our Lord. Amen.",
      "prayer-for-the-church": "Gracious Father, we pray for thy holy Catholic Church. Fill it with all truth, in all truth with all peace. Where it is corrupt, purify it; where it is in error, direct it; where in any thing it is amiss, reform it. Where it is right, strengthen it; where it is in want, provide for it; where it is divided, reunite it; for the sake of Jesus Christ thy Son our Savior. Amen.",
      "prayer-for-the-world": "Almighty God, from whom all thoughts of truth and peace proceed: Kindle, we pray, in the hearts of all people the true love of peace, and guide with thy pure and peaceable wisdom those who take counsel for the nations of the earth; that in tranquillity thy kingdom may go forward, till the earth is filled with the knowledge of thy love; through Jesus Christ our Lord. Amen."
  };
  const prayerText = prayers[prayerId];
  const dropdown = document.getElementById('prayer-dropdown');
  const selectedOption = dropdown.options[dropdown.selectedIndex];
  const prayerTitle = selectedOption ? selectedOption.text : 'Selected Prayer';
  document.getElementById('single-prayer-content').innerHTML = `<div class="office-container"><h2>${prayerTitle}</h2><p class="component-text">${prayerText || 'Prayer text not found'}</p></div>`;
  document.getElementById('prayer-display').style.display = 'block';
  document.getElementById('prayer-selection').style.display = 'none';
}
function backToPrayerDropdown() {
  document.getElementById('prayer-display').style.display = 'none';
  document.getElementById('prayer-selection').style.display = 'block';
}
function backToSplash() {
  document.getElementById('daily-office-section').style.display = 'none';
  document.getElementById('individual-prayers-section').style.display = 'none';
  document.getElementById('prayer-display').style.display = 'none';
  document.body.style.display = 'flex';
  document.body.style.alignItems = 'center';
  document.body.style.justifyContent = 'center';
  document.body.style.height = '100vh';
  document.body.style.overflowY = 'hidden';
  document.body.classList.remove('office-active');
  document.getElementById('splash-bg').style.display = 'block';
  document.getElementById('mode-selection').style.display = 'block';
  selectedMode = null;
}
// init() is now called only when Daily Office mode is selected
</script>
</body>
</html>