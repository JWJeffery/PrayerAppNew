<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Universal Office</title>
    <style>
       :root { 
           --bg-color: #f4f1ea; 
           --text-color: #2c3e50; 
           --container-bg: #ffffff; 
           --accent: #8e44ad; 
           --gold: #d4af37; 
           --sidebar-bg: #1a1a1a; 
       }
       body.dark-mode { 
           --bg-color: #121212; 
           --text-color: #e0e0e0; 
           --container-bg: #1e1e1e; 
           --sidebar-bg: #000000; 
       }
       body { 
           font-family: 'Georgia', serif; 
           background-color: var(--bg-color); 
           color: var(--text-color); 
           margin: 0; 
           display: flex; 
           flex-direction: column; 
           align-items: center; 
           justify-content: center; 
           height: 100vh; 
           transition: all 0.3s; 
       }

       #mode-selection { 
           text-align: center; 
           max-width: 600px; 
           padding: 40px; 
           background: var(--container-bg); 
           border-radius: 8px; 
           box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
       }
       #mode-selection h1 { font-size: 2.5em; margin-bottom: 20px; }
       .mode-btn { 
           background: var(--accent); 
           color: white; 
           border: none; 
           padding: 15px 30px; 
           margin: 10px; 
           cursor: pointer; 
           font-size: 1.2em; 
           border-radius: 4px; 
           transition: background 0.2s; 
       }
       .mode-btn:hover { background: #9b59b6; }

       #daily-office-section { display: none; flex-direction: row; width: 100%; height: 100vh; }
       #settings-panel { 
           width: 300px; 
           background: var(--sidebar-bg); 
           color: #e0e0e0; 
           padding: 25px; 
           height: 100vh; 
           position: sticky; 
           top: 0; 
           overflow-y: auto; 
           border-right: 2px solid var(--gold); 
       }
       .setting-group { 
           margin-bottom: 25px; 
           text-align: left; 
       }
       .setting-group strong { 
           display: block; 
           margin-bottom: 10px; 
           color: var(--gold); 
           text-transform: uppercase; 
           letter-spacing: 1px; 
           font-size: 0.8em; 
       }
       .setting-group label { 
           display: block; 
           margin-bottom: 10px; 
           cursor: pointer; 
           font-size: 0.95em; 
       }
       .nested-group { 
           margin-left: 15px; 
           margin-top: 10px; 
       }

       #main-content { 
           flex-grow: 1; 
           padding: 40px; 
           text-align: center; 
           overflow-y: auto; 
       }
       .office-container { 
           background: var(--container-bg); 
           max-width: 800px; 
           margin: 0 auto; 
           padding: 60px; 
           border-radius: 8px; 
           box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
           text-align: left; 
           border-left: 5px solid var(--accent); 
       }

       h1 { font-size: 2.5em; letter-spacing: 0.05em; margin-bottom: 0.5em; color: var(--text-color); }
       h2 { font-size: 2em; color: var(--accent); border-bottom: 1px solid var(--gold); padding-bottom: 10px; margin-top: 0; }

       .rubric-text { 
           color: var(--accent); 
           font-family: 'Georgia', serif; 
           font-variant: small-caps; 
           font-weight: 700; 
           font-size: 1.4em; 
           letter-spacing: 0.02em; 
           display: block; 
           margin-top: 35px; 
           margin-bottom: 10px; 
           border-bottom: 1px dotted var(--gold); 
           padding-bottom: 2px; 
           width: 100%; 
       }

       .passage-reference {
           font-size: 1.1em;
           font-style: italic;
           color: var(--gold);
           margin: 8px 0 12px 0;
           font-weight: normal;
       }

       .component-text { 
           font-size: 1.2em; 
           line-height: 1.6; 
           margin-bottom: 30px; 
           display: block; 
           white-space: pre-wrap; 
           word-wrap: break-word; 
           overflow: visible; 
       }

       .psalm-verse { display: block; margin-bottom: 8px; font-size: 1.15em; }
       .verse-num { font-size: 0.65em; color: var(--gold); vertical-align: super; margin-right: 8px; opacity: 0.8; }

       .saint-section { margin-top: 60px; border-top: 2px double var(--accent); padding-top: 40px; }
       .saint-grid { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
       .saint-box { background: var(--container-bg); border-top: 5px solid var(--gold); padding: 20px; width: 240px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); text-align: left; border-radius: 0 0 6px 6px; }

       .ordo-control { background: #222; border: 1px solid var(--gold); padding: 15px; border-radius: 4px; margin-bottom: 20px; text-align: center; }
       .ordo-date { display: block; color: var(--gold); font-weight: bold; margin: 10px 0; font-size: 1.1em; }
       .ordo-btn { background: none; border: 1px solid var(--gold); color: var(--gold); padding: 5px 15px; cursor: pointer; margin: 0 5px; transition: background 0.2s; }
       .ordo-btn:hover { background: rgba(212, 175, 55, 0.2); }
       select { width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 4px; }

       #individual-prayers-section { display: none; text-align: center; max-width: 800px; padding: 40px; width: 100%; }
       #prayer-selection { margin-bottom: 40px; }
       #prayer-display { background: var(--container-bg); padding: 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: left; }
    </style>
</head>
<body id="app-body">
    <div id="mode-selection">
        <h1>Welcome to The Universal Office</h1>
        <p>Select your mode:</p>
        <button class="mode-btn" onclick="selectMode('daily')">Daily Office</button>
        <button class="mode-btn" onclick="selectMode('prayers')">Individual Prayers</button>
    </div>

    <div id="daily-office-section">
        <div id="settings-panel">
            <h3 style="color:var(--gold)">Office Settings</h3>
            <div class="ordo-control">
                <strong>Liturgical Ordo</strong>
                <div class="ordo-date" id="display-date">Loading...</div>
                <button class="ordo-btn" onclick="changeDate(-1)">Prev</button>
                <button class="ordo-btn" onclick="resetDate()">Today</button>
                <button class="ordo-btn" onclick="changeDate(1)">Next</button>
                <div id="calendar-info" style="font-size: 0.7em; color: var(--gold); margin-top:10px;">Exploring the Ordo...</div>
            </div>
            <div class="setting-group">
                <strong>Time of Day:</strong>
                <label><input type="radio" name="office-time" value="morning-office" onchange="renderOffice()" checked> Morning Prayer</label>
                <label><input type="radio" name="office-time" value="noonday-office" onchange="renderOffice()"> Noonday Prayer</label>
                <label><input type="radio" name="office-time" value="evening-office" onchange="renderOffice()"> Evening Prayer</label>
                <label><input type="radio" name="office-time" value="compline-office" onchange="renderOffice()"> Compline</label>
            </div>
            <div class="setting-group">
                <strong>Appearance:</strong>
                <label><input type="checkbox" id="toggle-dark" onchange="updateUI()" checked> Dark Mode</label>
            </div>
            <div class="setting-group">
                <strong>Language & Rite:</strong>
                <label><input type="radio" name="rite" value="rite1" onchange="renderOffice()"> Rite I (Traditional)</label>
                <label><input type="radio" name="rite" value="rite2" onchange="renderOffice()" checked> Rite II (Contemporary)</label>
            </div>
            <div class="setting-group">
                <strong>Officiant:</strong>
                <label><input type="radio" name="minister" value="priest" onchange="renderOffice()"> Priest</label>
                <label><input type="radio" name="minister" value="lay" onchange="renderOffice()" checked> Layperson</label>
            </div>
            <div class="setting-group">
                <strong>Tradition Devotions:</strong>
                <div class="nested-group">
                    <strong>Marian Antiphon:</strong>
                    <label><input type="radio" name="marian-antiphon-pos" value="none" onchange="renderOffice()" checked> None</label>
                    <label><input type="radio" name="marian-antiphon-pos" value="before" onchange="renderOffice()"> Before</label>
                    <label><input type="radio" name="marian-antiphon-pos" value="after" onchange="renderOffice()"> After</label>
                </div>
                <label style="margin-top:10px;"><input type="checkbox" id="toggle-gloria-patri" onchange="renderOffice()" checked> Gloria Patri (after Psalm)</label>
                <label><input type="checkbox" id="toggle-angelus" onchange="renderOffice()" checked> Angelus (Catholic)</label>
                <label><input type="checkbox" id="toggle-trisagion" onchange="renderOffice()" checked> Trisagion (Eastern Orthodox)</label>
                <label><input type="checkbox" id="toggle-theotokion" onchange="renderOffice()" checked> Theotokion (Oriental Orthodox)</label>
                <label><input type="checkbox" id="toggle-jesus-prayer" onchange="renderOffice()" checked> Jesus Prayer (Eastern Orthodox)</label>
                <label><input type="checkbox" id="toggle-assyrian-blessing" onchange="renderOffice()" checked> Assyrian Blessing (Church of the East)</label>
                <label><input type="checkbox" id="toggle-agpeya-opening" onchange="renderOffice()" checked> Agpeya Opening (Coptic)</label>
            </div>
            <div class="setting-group">
                <strong>Creed Selection:</strong>
                <select id="creed-type" onchange="renderOffice()">
                    <option value="bcp-creed-apostles">Apostles' Creed</option>
                    <option value="bcp-creed-nicene">Nicene Creed</option>
                </select>
            </div>
            <div class="setting-group">
                <strong>Ordo Components:</strong>
                <label><input type="checkbox" id="toggle-litany" onchange="renderOffice()"> The Great Litany</label>
                <label><input type="checkbox" id="toggle-suffrages" onchange="renderOffice()" checked> Suffrages</label>
            </div>
        </div>

        <div id="main-content">
            <h1>The Universal Office</h1>
            <div id="office-display"></div>
            <div class="saint-section">
                <h2 id="date-header">Commemorations</h2>
                <div id="saint-display" class="saint-grid"></div>
            </div>
        </div>
    </div>

    <div id="individual-prayers-section">
        <h1>Individual Prayers</h1>
        <select id="prayer-dropdown" style="width: 300px; padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 4px;">
            <option value="">Select a Prayer</option>
            <option value="prayer-for-the-sick">Prayer for the Sick</option>
            <option value="prayer-for-peace">Prayer for Peace</option>
            <option value="prayer-for-unity">Prayer for Unity</option>
            <option value="prayer-for-mission">Prayer for Mission</option>
            <option value="prayer-for-guidance">Prayer for Guidance</option>
            <option value="prayer-for-the-church">Prayer for the Church</option>
            <option value="prayer-for-the-world">Prayer for the World</option>
        </select>
        <button class="mode-btn" onclick="showSinglePrayer()">Display Prayer</button>
    </div>
    <div id="prayer-display" style="display:none; margin-top:40px;">
        <div class="office-container" id="single-prayer-content"></div>
        <button class="mode-btn" onclick="backToPrayerDropdown()" style="margin-top:20px;">Back to Selection</button>
    </div>

    <script>
    let appData = null;
    let currentDate = new Date();
    let selectedMode = null;

    let seasonalCache = {};

    const seasonRanges = [
      { start: new Date("2025-11-30"), end: new Date("2025-12-24"), season: "advent", file: "advent.json" },
      { start: new Date("2025-12-25"), end: new Date("2026-01-05"), season: "christmas", file: "christmas.json" },
      { start: new Date("2026-01-06"), end: new Date("2026-02-22"), season: "epiphany", file: "epiphany.json" },
      { start: new Date("2026-02-23"), end: new Date("2026-04-11"), season: "lent", file: "lent.json" },
      { start: new Date("2026-04-12"), end: new Date("2026-05-24"), season: "easter", file: "easter.json" },
      { start: new Date("2026-05-25"), end: new Date("2026-12-31"), season: "ordinary", file: "ordinary1.json" }
    ];

    function formatDateForLookup(date) {
      const options = { month: 'long', day: 'numeric', year: 'numeric' };
      return date.toLocaleDateString('en-US', options);
    }

    function getSeasonAndFile(targetDate) {
      const date = new Date(targetDate);
      for (const range of seasonRanges) {
        if (date >= range.start && date <= range.end) {
          return { season: range.season, file: range.file };
        }
      }
      console.warn(`No season match for ${date.toDateString()} – fallback to ordinary`);
      return { season: "ordinary", file: "ordinary1.json" };
    }

    async function loadSeasonalData(seasonFile) {
      if (seasonalCache[seasonFile]) return seasonalCache[seasonFile];

      try {
        const response = await fetch(`data/${seasonFile}`);
        if (!response.ok) throw new Error(`HTTP ${response.status} for ${seasonFile}`);
        const data = await response.json();
        seasonalCache[seasonFile] = data;
        console.log(`Loaded & cached ${seasonFile} (${data.length} days)`);
        return data;
      } catch (err) {
        console.error(`Load failed for ${seasonFile}:`, err);
        return [];
      }
    }

    async function getDailyData(targetDate = currentDate) {
      const { file } = getSeasonAndFile(targetDate);
      const data = await loadSeasonalData(file);
      if (!data.length) return { title: "No data available", liturgicalColor: "green", antiphon: "", psalms_morning: "", reading_ot_morning: "", reading_epistle_morning: "", reading_gospel_morning: "", psalms_evening: "", reading_ot_evening: "", reading_epistle_evening: "", reading_gospel_evening: "" };
      const lookup = formatDateForLookup(targetDate);
      const entry = data.find(d => d.date === lookup);
      if (entry) {
        console.log(`Found match for ${lookup} in ${file}`);
        return entry;
      }
      console.warn(`No exact match for ${lookup} in ${file} – using first entry`);
      return data[0];
    }

    function updateSeasonalTheme(color) {
      let hex = '#8e44ad';
      if (color === 'purple') hex = '#8e44ad';
      if (color === 'rose') hex = '#e74c3c';
      if (color === 'white') hex = '#f0f0f0';
      if (color === 'green') hex = '#27ae60';
      if (color === 'red') hex = '#c0392b';
      document.documentElement.style.setProperty('--accent', hex);
    }

    async function init() {
        try {
            appData = {};
            const files = ['components', 'rubrics', 'saints'];
            for (const file of files) {
                const res = await fetch(`data/${file}.json`);
                if (!res.ok) throw new Error(`Missing: data/${file}.json`);
                appData[file] = await res.json();
            }

            const otRes = await fetch('data/bible/old-testament.json');
            if (otRes.ok) appData['oldTestament'] = await otRes.json();
            const ntRes = await fetch('data/bible/new-testament.json');
            if (ntRes.ok) appData['newTestament'] = await ntRes.json();
            console.log("NT Contents:", appData['newTestament']);
            const psalmsRes = await fetch('data/bible/psalms.json');
            if (psalmsRes.ok) appData['psalms'] = await psalmsRes.json();

            updateUI();

            await getDailyData();

            renderOffice();

        } catch (err) {
            document.getElementById('office-display').innerHTML = `<div class="office-container"><h3>System Error</h3><p>${err.message}</p></div>`;
            console.error('Init failed:', err);
        }
    }

    function selectMode(mode) {
        selectedMode = mode;
        document.getElementById('mode-selection').style.display = 'none';
        document.body.style.height = 'auto';
        document.body.style.justifyContent = 'flex-start';
        if (mode === 'daily') {
            document.getElementById('daily-office-section').style.display = 'flex';
            renderOffice();
        } else if (mode === 'prayers') {
            document.getElementById('individual-prayers-section').style.display = 'block';
        }
    }

    function changeDate(days) { 
      currentDate.setDate(currentDate.getDate() + days); 
      renderOffice(); 
    }

    function resetDate() { 
      currentDate = new Date(); 
      renderOffice(); 
    }

    function updateUI() {
        const isDark = document.getElementById('toggle-dark')?.checked || false;
        if (isDark) document.body.classList.add('dark-mode');
        else document.body.classList.remove('dark-mode');
    }

    function getScriptureText(refId, version = "NRSV") {
        if (!refId) return "No reference provided";
        refId = refId.toUpperCase().trim();
        let source = null;
        if (refId.startsWith("PSA") || refId.startsWith("PSALM")) {
            source = appData['psalms'];
        } else if (refId.includes("ACTS") || refId.includes("JOHN") || refId.includes("EPH") || refId.includes("MARK") || refId.includes("ROM") || refId.includes("HEB") || refId.includes("COR") || refId.includes("MATT") || refId.includes("GAL") || refId.includes("HEBREWS") || refId.includes("TIMOTHY") || refId.includes("TIM") || refId.includes("TITUS") || refId.includes("PHILEMON") || refId.includes("JAMES") || refId.includes("PETER") || refId.includes("PET") || refId.includes("JUDE") || refId.includes("REVELATION") || refId.includes("REV") || refId.includes("PHILIPPIANS") || refId.includes("PHIL") || refId.includes("COLOSSIANS") || refId.includes("COL") || refId.includes("THESSALONIANS") || refId.includes("THESS")) {
            source = appData['newTestament'];
        } else {
            source = appData['oldTestament'];
        }
        if (!source) return "Bible library not loaded";
        const entry = source.find(s => s.id.toUpperCase().trim() === refId);
        if (!entry) return "Text not found for " + refId;
        let text = entry.text[version] || entry.text["KJV"] || null;
        if (text) {
            text = text.replace(/^.*?:\s*/, '').trim();
            text = text.replace(/^\d+:\d+(-\d+)?\s*/gm, '');
            text = text.replace(/\n/g, ' ');
            text = text.replace(/^["“‘]/, '').trim();
        }
        return text || "Text not found for " + refId;
    }

    async function renderOffice() {
        if (!appData || !appData.rubrics || !Array.isArray(appData.rubrics)) {
            document.getElementById('office-display').innerHTML = `<div class="office-container"><h3>Loading...</h3><p>Data still loading.</p></div>`;
            return;
        }

        const todayKey = currentDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
        document.getElementById('display-date').innerText = todayKey;

        const officeId = document.querySelector('input[name="office-time"]:checked')?.value;
        const rite = document.querySelector('input[name="rite"]:checked')?.value || 'rite2';
        const minister = document.querySelector('input[name="minister"]:checked')?.value;
        const marianPos = document.querySelector('input[name="marian-antiphon-pos"]:checked')?.value || 'none';
        const creedSelection = document.getElementById('creed-type')?.value;
        const greatLitanyChecked = document.getElementById('toggle-litany')?.checked || false;
        const suffragesChecked = document.getElementById('toggle-suffrages')?.checked || false;

        const devotions = [];
        if (document.getElementById('toggle-angelus').checked) devotions.push('bcp-angelus');
        if (document.getElementById('toggle-trisagion').checked) devotions.push('bcp-trisagion');
        if (document.getElementById('toggle-theotokion').checked) devotions.push('bcp-theotokion');
        if (document.getElementById('toggle-jesus-prayer').checked) devotions.push('bcp-jesus-prayer');
        if (document.getElementById('toggle-assyrian-blessing').checked) devotions.push('bcp-assyrian-blessing');
        if (document.getElementById('toggle-agpeya-opening').checked) devotions.push('bcp-agpeya-opening');

        const { season } = getSeasonAndFile(currentDate);
        const marianId = `bcp-marian-antiphon-${season}`;
        const marianComp = appData.components.find(c => c.id === marianId);

        const activeRubric = appData.rubrics.find(r => r.id === officeId);

        const dailyData = await getDailyData(currentDate);
        document.getElementById('calendar-info').innerText = dailyData.title || "Liturgical Ordo";

        updateSeasonalTheme(dailyData.liturgicalColor || 'purple');

        const isEvening = (officeId === 'evening-office') || (officeId === 'compline-office');
        const suffix = isEvening ? '_evening' : '_morning';

        let psalms = dailyData[`psalms${suffix}`] || "";
        let readingOT = dailyData[`reading_ot${suffix}`] || "";
        let readingEpistle = dailyData[`reading_epistle${suffix}`] || "";
        let readingGospel = dailyData[`reading_gospel${suffix}`] || "";

        let officeHtml = `<div class="office-container"><h2>${activeRubric?.officeName || "Office"}</h2>`;
        officeHtml += `<p style="color:var(--gold); font-variant:small-caps; font-weight:bold;">${dailyData.title || "Day Title"}</p>`;

        if (marianPos === 'before' && marianComp) {
          let marianText = marianComp.text[rite] || marianComp.text['rite2'] || "Marian Antiphon text not found";
          officeHtml += `<span class="rubric-text">Marian Antiphon</span><span class="component-text"><i>${marianText}</i></span>`;
        }

        if (dailyData.antiphon) {
          officeHtml += `<span class="rubric-text">Antiphon</span><span class="component-text"><i>${dailyData.antiphon}</i></span>`;
        }

        activeRubric?.sequence?.forEach(item => {
            if (item === 'bcp-gloria-patri' && !document.getElementById('toggle-gloria-patri').checked) {
              return;
            }
            if (item === 'bcp-litany' && !greatLitanyChecked) {
              return;
            }
            if (item === 'bcp-suffrages-slot' && !suffragesChecked) {
              return;
            }
            if (item === 'bcp-suffrages-slot') {
              item = `bcp-suffrages-${rite}`;
            }
            if (item === 'bcp-creed-slot') {
              item = creedSelection;
            }

            if (item === "VARIABLE_READING_OT") {
                officeHtml += `<span class="rubric-text">The Old Testament Lesson</span>`;
                if (readingOT) {
                    officeHtml += `<h4 class="passage-reference">${readingOT}</h4>`;
                    const fullText = getScriptureText(readingOT);
                    officeHtml += `<span class="component-text">${fullText || "No reading appointed"}</span>`;
                } else {
                    officeHtml += `<span class="component-text">No reading appointed</span>`;
                }
                officeHtml += '<br><hr style="border: 1px solid var(--gold); margin: 10px 0;">';
                return;
            }

            if (item === "VARIABLE_READING_EPISTLE") {
                officeHtml += `<span class="rubric-text">The Epistle</span>`;
                if (readingEpistle) {
                    officeHtml += `<h4 class="passage-reference">${readingEpistle}</h4>`;
                    const fullText = getScriptureText(readingEpistle);
                    officeHtml += `<span class="component-text">${fullText || "No reading appointed"}</span>`;
                } else {
                    officeHtml += `<span class="component-text">No reading appointed</span>`;
                }
                officeHtml += '<br><hr style="border: 1px solid var(--gold); margin: 10px 0;">';
                return;
            }

            if (item === "VARIABLE_READING_GOSPEL") {
                officeHtml += `<span class="rubric-text">The Holy Gospel</span>`;
                if (readingGospel) {
                    officeHtml += `<h4 class="passage-reference">${readingGospel}</h4>`;
                    const fullText = getScriptureText(readingGospel);
                    officeHtml += `<span class="component-text">${fullText || "No reading appointed"}</span>`;
                } else {
                    officeHtml += `<span class="component-text">No reading appointed</span>`;
                }
                officeHtml += '<br><hr style="border: 1px solid var(--gold); margin: 10px 0;">';
                return;
            }

            if (item === "VARIABLE_PSALM") {
                if (psalms) {
                    let psalmRefs = psalms.split(',').map(p => p.trim());
                    let psalmHtml = "";
                    psalmRefs.forEach(psalm => {
                        let psalmId = psalm.toUpperCase();
                        if (!psalmId.startsWith('PSALM ')) psalmId = 'PSALM ' + psalmId;
                        const fullText = getScriptureText(psalmId);
                        psalmHtml += `<h4 class="passage-reference">${psalm}</h4><span class="component-text">${fullText || "No psalm text found"}</span>`;
                        if (document.getElementById('toggle-gloria-patri').checked) {
                            const gloria = appData.components.find(c => c.id === "bcp-gloria-patri");
                            let gloriaText = gloria ? (gloria.text[rite] || gloria.text['rite2'] || "(Gloria Patri)") : "(Gloria Patri not found)";
                            psalmHtml += `<span class="component-text"><i>${gloriaText}</i></span>`;
                        }
                    });
                    officeHtml += `<div class="component-text">${psalmHtml}</div>`;
                }
                return;
            }

            let compId = (typeof item === 'object') ? item[rite] : item;
            const comp = appData.components.find(c => c.id === compId);
            if (comp) {
                let displayText = comp.text;
                if (typeof displayText === 'object' && displayText !== null) {
                    displayText = displayText[rite] || displayText['rite2'] || displayText['rite1'] || "Text not found";
                }
                officeHtml += `<span class="rubric-text">${comp.title}</span><span class="component-text">${displayText}</span>`;
            }
        });

        if (marianPos === 'after' && marianComp) {
          let marianText = marianComp.text[rite] || marianComp.text['rite2'] || "Marian Antiphon text not found";
          officeHtml += `<span class="rubric-text">Marian Antiphon</span><span class="component-text"><i>${marianText}</i></span>`;
        }

        if (devotions.length > 0) {
          officeHtml += `<span class="rubric-text">Tradition Devotions</span>`;
          devotions.forEach(devId => {
            const comp = appData.components.find(c => c.id === devId);
            if (comp) {
              let displayText = comp.text[rite] || comp.text['rite2'] || "Text not found";
              officeHtml += `<span class="rubric-text">${comp.title}</span><span class="component-text">${displayText}</span>`;
            }
          });
        }

        document.getElementById('office-display').innerHTML = officeHtml + `</div>`;

        document.getElementById('date-header').innerText = `Commemorations for ${todayKey}`;
        const todayKeyLower = todayKey.toLowerCase();

        document.getElementById('saint-display').innerHTML = appData.saints
            .filter(s => s.day && s.day.toLowerCase().includes(todayKeyLower))
            .map(s => `
                <div class="saint-box">
                    <small style="color:var(--accent); font-weight:bold; text-transform:uppercase;">${s.tradition || 'Unknown'}</small>
                    <strong>${s.name || 'Unknown'}</strong>
                    <p>${s.description || 'No description'}</p>
                </div>
            `).join('') || '<p>No commemorations for today.</p>';
    }

    function showSinglePrayer() {
        const prayerId = document.getElementById('prayer-dropdown').value;
        if (!prayerId) {
            alert("Please select a prayer first.");
            return;
        }

        const prayers = {
            "prayer-for-the-sick": "O Father of mercies, and God of all comfort, our only help in time of need: We humbly beseech thee to behold, visit, and relieve thy sick servant [Name] for whom our prayers are desired. Look upon him with the eyes of thy mercy; comfort him with a sense of thy goodness; preserve him from the temptations of the enemy; and give him patience under his affliction. In thy good time, restore him to health, and enable him to lead the residue of his life in thy fear, and to thy glory; and grant that finally he may dwell with thee in life everlasting; through Jesus Christ our Lord. Amen.",
            "prayer-for-peace": "O God, the source of all holy desires, all good counsels, and all just works: Give to thy servants that peace which the world cannot give; that our hearts may be set to obey thy commandments, and also that by thee, we, being defended from the fear of our enemies, may pass our time in rest and quietness; through the merits of Jesus Christ our Savior. Amen.",
            "prayer-for-unity": "O God the Father of our Lord Jesus Christ, in whom thou art well pleased, grant, we beseech thee, that being knit together in the same mind and in the same judgment, we may all speak the same thing, and be of one accord, of one mind, and that there be no divisions among us; but that we be perfectly joined together in the same mind and in the same judgment. Amen.",
            "prayer-for-mission": "Lord Jesus Christ, who didst stretch out thy loving arms on the hard wood of the Cross that everyone might come within the reach of thy saving embrace: So clothe us in thy Spirit that we, reaching forth our hands in love, may bring those who do not know thee to the knowledge and love of thee; for the honor of thy Name. Amen.",
            "prayer-for-guidance": "O God, by whom the meek are guided in judgment, and light riseth up in darkness for the godly: Grant us, in all our doubts and uncertainties, the grace to ask what thou wouldest have us to do, that the Spirit of wisdom may save us from all false choices; that we may find the right path, and walk in it; through Jesus Christ our Lord. Amen.",
            "prayer-for-the-church": "Gracious Father, we pray for thy holy Catholic Church. Fill it with all truth, in all truth with all peace. Where it is corrupt, purify it; where it is in error, direct it; where in any thing it is amiss, reform it. Where it is right, strengthen it; where it is in want, provide for it; where it is divided, reunite it; for the sake of Jesus Christ thy Son our Savior. Amen.",
            "prayer-for-the-world": "Almighty God, from whom all thoughts of truth and peace proceed: Kindle, we pray, in the hearts of all people the true love of peace, and guide with thy pure and peaceable wisdom those who take counsel for the nations of the earth; that in tranquillity thy kingdom may go forward, till the earth is filled with the knowledge of thy love; through Jesus Christ our Lord. Amen."
        };

        const prayerText = prayers[prayerId];

        const dropdown = document.getElementById('prayer-dropdown');
        const selectedOption = dropdown.options[dropdown.selectedIndex];
        const prayerTitle = selectedOption ? selectedOption.text : 'Selected Prayer';

        document.getElementById('single-prayer-content').innerHTML = `<div class="office-container"><h2>${prayerTitle}</h2><p class="component-text">${prayerText || 'Prayer text not found'}</p></div>`;

        document.getElementById('prayer-display').style.display = 'block';
        document.getElementById('prayer-selection').style.display = 'none';
    }

    function backToPrayerDropdown() {
        document.getElementById('prayer-display').style.display = 'none';
        document.getElementById('prayer-selection').style.display = 'block';
    }

    init();
    </script>
</body>
</html>